---
title: Redis开发与运维笔记-集群
abbrlink: ddc0d24d
categories:
  - 数据库
  - Redis
tags:
  - Redis
author: 长歌
date: 2021-05-28 22:20:00
---



{% cq %}

Redis Cluster是Redis的分布式解决方案，在3.0版本正式推出，有效地解决了Redis分布式方面的需求。当遇到单机内存、并发、流量等瓶颈时，可以采用Cluster架构方案达到负载均衡的目的。

{% endcq %}

<!-- more -->



> 参考书籍：[Redis开发与运维](https://book.douban.com/subject/26971561/)

---



# 集群

## 数据分布



### Redis数据分布

Redis Cluser采用虚拟槽分区，所有的键根据哈希函数映射到0~16383整数槽内，计算公式：`slot=CRC16（key）&16383`

Redis虚拟槽分区的特点：
- 解耦数据和节点之间的关系，简化了节点扩容和收缩难度。 
- 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据。 
- 支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景



### Redis分布式集群功能限制

1. key批量操作支持有限。如mset、mget，目前只支持具有相同slot值的key执行批量操作。对于映射为不同slot值的key由于执行mget、mget等操作可 能存在于多个节点上因此不被支持。
2. key事务操作支持有限。同理只支持多key在同一节点上的事务操作，当多个key分布在不同的节点上时无法使用事务功能。 
3. key作为数据分区的最小粒度，因此不能将一个大的键值对象如hash、list等映射到不同的节点。 
4. 不支持多数据库空间。单机下的Redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0。 
5. 复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构






## 节点通信

​	Redis集群采用P2P的Gossip（流言）协议， Gossip协议工作原理就是节点彼此不断通信交换信息，一段时间后所有的节 点都会知道集群完整的信息，这种方式类似流言传播。



### Gossip消息

常用的Goosip消息分为：ping消息、pong消息、meet消息、fail消息等

- meet消息：用于通知新节点加入
- ping消息：每个节点向其他多个节点发送ping消息，消息中含有节点自身及其他部分节点的状态数据。
- pong消息：接收到meet、ping消息时作为返回数据，封装自身状态信息。也可以广播pong消息用于通知其他节点更新当前节点状态。
- fail消息：当节点判定其他节点下线时，会向集群内广播fail消息，其他节点收到消息后将标记节点设置为下线状态。





## 搭建集群

搭建集群需要以下三个步骤：
1. 准备节点
2. 节点握手
3. 分配槽

搭建集群以及集群伸缩部分可以参考如下文章：
- [Redis集群搭建(Redis3.0版)](./778231993) 
- [Redis集群搭建(Redis5.0版)](./1044596185)




## 请求路由

### 请求重定向

​	在集群模式下，Redis接收任何键相关命令时首先计算键对应的槽，再根据槽找出所对应的节点，如果节点是自身，则处理键命令；否则回复 MOVED重定向错误，通知客户端请求正确的节点。这个过程称为MOVED重定向。

### hash_tag

​	如果键值包含`{hash_tag}`，计算键值对应的槽时会使用大括号内的内容进行计算，可以利用此特性保持业务相关性强的内容分不到同一个槽内。

> Pipeline同样可以受益于hash_tag，由于Pipeline只能向一个节点批量发送执行命令，而相同slot必然会对应到唯一的节点，降低了集群使用Pipeline的门槛



### Smart客户端

​	客户端通过缓存槽与节点映射关系来进行命令的执行，当出现Move重定向错误时，向正确的节点发送命令并更新本地缓存。流程如下：

![Smart客户端操作流程](Redis开发与运维笔记_集群/Smart客户端操作流程.png)

> 针对高并发的场景，客户端与Redis实例通信这里是绝对的热点代码。集群协议通过Smart客户端全面高效的支持需要一个过程，因此用户在选择Smart客户端时要重点审核集群交互代码，防止线上踩坑。必要时可以自行优化修改客户端源码。



### ASK重定向

当一个slot数据从源节点迁移到目标节点时，期间可能出现一部分数据在源节点，而另一部分在目标节点。

1. 当集群进行槽迁移时，客户端根据本地缓存发送命令到源节点，如果源节点存在数据则直接返回
2. 如果键对象不存在，可能在目标节点中，节点返回ASK重定向错误，格式为`(error)ASK {slot} {targetIP} : {targetPort}`
3. 客户端提取目标节点信息，发送`asking`命令打开客户端连接标识，再执行键命令，如果存在则执行，不存在则返回不存在信息。

- ASK和MOVE虽然都返回目标节点，但是意义不同，ASK返回表示当前正在迁移键，不确定何时能完成，客户端此时不需要更新本地缓存。

> 集群环境下对于使用批量操作的场景，建议优先使用Pipeline方式，在客户端实现对ASK重定向的正确处理，这样既可以受益于批量操作的IO优化，又可以兼容slot迁移场景。



## 故障转移



## 集群运维



## 本章重点回顾





[^1]: 关于Gossip协议可参考[P2P 网络核心技术：Gossip 协议](https://zhuanlan.zhihu.com/p/41228196)

