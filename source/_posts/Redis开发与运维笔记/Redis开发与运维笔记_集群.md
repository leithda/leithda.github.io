---
title: Redis开发与运维笔记-集群
abbrlink: ddc0d24d
categories:
  - 数据库
  - Redis
tags:
  - Redis
author: 长歌
date: 2021-05-28 22:20:00
---



{% cq %}

Redis Cluster是Redis的分布式解决方案，在3.0版本正式推出，有效地解决了Redis分布式方面的需求。当遇到单机内存、并发、流量等瓶颈时，可以采用Cluster架构方案达到负载均衡的目的。

{% endcq %}

<!-- more -->



> 参考书籍：[Redis开发与运维](https://book.douban.com/subject/26971561/)

---



# 集群

## 数据分布



### Redis数据分布

Redis Cluser采用虚拟槽分区，所有的键根据哈希函数映射到0~16383整数槽内，计算公式：`slot=CRC16（key）&16383`

Redis虚拟槽分区的特点：
- 解耦数据和节点之间的关系，简化了节点扩容和收缩难度。 
- 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据。 
- 支持节点、槽、键之间的映射查询，用于数据路由、在线伸缩等场景



### Redis分布式集群功能限制

1. key批量操作支持有限。如mset、mget，目前只支持具有相同slot值的key执行批量操作。对于映射为不同slot值的key由于执行mget、mget等操作可 能存在于多个节点上因此不被支持。
2. key事务操作支持有限。同理只支持多key在同一节点上的事务操作，当多个key分布在不同的节点上时无法使用事务功能。 
3. key作为数据分区的最小粒度，因此不能将一个大的键值对象如hash、list等映射到不同的节点。 
4. 不支持多数据库空间。单机下的Redis可以支持16个数据库，集群模式下只能使用一个数据库空间，即db0。 
5. 复制结构只支持一层，从节点只能复制主节点，不支持嵌套树状复制结构






## 节点通信

​	Redis集群采用P2P的Gossip（流言）协议， Gossip协议工作原理就是节点彼此不断通信交换信息，一段时间后所有的节 点都会知道集群完整的信息，这种方式类似流言传播。



### Gossip消息

常用的Goosip消息分为：ping消息、pong消息、meet消息、fail消息等

- meet消息：用于通知新节点加入
- ping消息：每个节点向其他多个节点发送ping消息，消息中含有节点自身及其他部分节点的状态数据。
- pong消息：接收到meet、ping消息时作为返回数据，封装自身状态信息。也可以广播pong消息用于通知其他节点更新当前节点状态。
- fail消息：当节点判定其他节点下线时，会向集群内广播fail消息，其他节点收到消息后将标记节点设置为下线状态。





## 搭建集群

搭建集群需要以下三个步骤：
1. 准备节点
2. 节点握手
3. 分配槽

搭建集群以及集群伸缩部分可以参考如下文章：
- [Redis集群搭建(Redis3.0版)](./778231993) 
- [Redis集群搭建(Redis5.0版)](./1044596185)




## 请求路由

### 请求重定向

在集群模式下，Redis接收任何键相关命令时首先计算键对应的槽，再根据槽找出所对应的节点，如果节点是自身，则处理键命令；否则回复 MOVED重定向错误，通知客户端请求正确的节点。这个过程称为MOVED重定向。







## 故障转移



## 集群运维



## 本章重点回顾





[^1]: 关于Gossip协议可参考[P2P 网络核心技术：Gossip 协议](https://zhuanlan.zhihu.com/p/41228196)

